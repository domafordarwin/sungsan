<div class="page-header animate-in">
  <h1>봉사자 관리</h1>
  <% if policy(Member).create? %>
    <%= link_to "새 봉사자", new_member_path, class: "btn-ocean" %>
  <% end %>
</div>

<!-- 검색 + 필터 -->
<%= form_with url: members_path, method: :get, class: "filter-panel animate-in animate-delay-1", data: { turbo_frame: "members_list" } do |f| %>
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <div>
      <label class="label-basalt">검색</label>
      <%= f.text_field :q, value: params[:q], placeholder: "이름, 세례명, 구역",
          class: "input-basalt" %>
    </div>
    <div>
      <label class="label-basalt">활동 상태</label>
      <%= f.select :active, [["전체", ""], ["활동", "true"], ["비활동", "false"]],
          { selected: params[:active] }, class: "input-basalt" %>
    </div>
    <div>
      <label class="label-basalt">세례</label>
      <%= f.select :baptized, [["전체", ""], ["세례", "true"]],
          { selected: params[:baptized] }, class: "input-basalt" %>
    </div>
    <div class="flex items-end gap-2">
      <%= f.submit "검색", class: "btn-ocean cursor-pointer" %>
      <%= link_to "초기화", members_path, class: "btn-ghost" %>
    </div>
  </div>
<% end %>

<% is_admin = policy(Member).destroy? %>

<!-- 목록 -->
<%= turbo_frame_tag "members_list" do %>
  <div class="animate-in animate-delay-2" data-controller="<%= 'bulk-select' if is_admin %>">

    <% if is_admin %>
      <%= form_with url: bulk_destroy_members_path, method: :delete, id: "bulk-destroy-form", data: { turbo_confirm: "선택한 봉사자를 삭제하시겠습니까?" } do %>
        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
          <button type="submit" class="btn-lava" style="font-size: 0.8rem;" data-bulk-select-target="submitBtn" disabled>
            선택 삭제
          </button>
          <span data-bulk-select-target="count" style="font-size: 0.85rem; color: var(--basalt-600);"></span>
        </div>
    <% end %>
    <% end %>

    <table class="table-stone">
      <thead>
        <tr>
          <% if is_admin %>
            <th style="width: 2.5rem;">
              <input type="checkbox" data-bulk-select-target="selectAll" data-action="bulk-select#toggleAll">
            </th>
          <% end %>
          <th>이름</th>
          <th>세례명</th>
          <th>연락처</th>
          <th>구역</th>
          <th>상태</th>
          <th>관리</th>
        </tr>
      </thead>
      <tbody>
        <% @members.each do |member| %>
          <tr>
            <% if is_admin %>
              <td>
                <input type="checkbox" name="member_ids[]" value="<%= member.id %>"
                       form="bulk-destroy-form"
                       data-bulk-select-target="checkbox"
                       data-action="bulk-select#toggle">
              </td>
            <% end %>
            <td style="font-weight: 500; color: var(--basalt-800);"><%= member.name %></td>
            <td><%= member.baptismal_name %></td>
            <td><%= member.masked_phone %></td>
            <td><%= member.district %></td>
            <td>
              <% if member.active? %>
                <span class="badge badge-moss">활동</span>
              <% else %>
                <span class="badge badge-lava">비활동</span>
              <% end %>
            </td>
            <td style="white-space: nowrap;">
              <%= link_to "보기", member_path(member), class: "link-ocean", style: "font-size: 0.8rem;" %>
              <% if is_admin %>
                <%= button_to "삭제", member_path(member), method: :delete,
                    class: "link-lava", style: "font-size: 0.8rem; display: inline;",
                    data: { turbo_confirm: "'#{member.name}' 봉사자를 삭제하시겠습니까?" } %>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>

  </div>

  <!-- 페이지네이션 -->
  <% page = [params[:page].to_i, 1].max %>
  <div class="pagination">
    <% if page > 1 %>
      <%= link_to "이전", members_path(request.query_parameters.merge(page: page - 1)),
          class: "page-btn inactive" %>
    <% end %>
    <span class="page-btn active"><%= page %></span>
    <% if @members.size >= 20 %>
      <%= link_to "다음", members_path(request.query_parameters.merge(page: page + 1)),
          class: "page-btn inactive" %>
    <% end %>
  </div>
<% end %>
