<div class="max-w-3xl mx-auto">
  <div class="card-basalt animate-in" style="padding: 2rem; margin-bottom: 1.5rem;">
    <div class="flex justify-between items-center" style="margin-bottom: 1.5rem;">
      <h1 style="font-family: var(--font-display); font-size: 1.5rem; font-weight: 700;"><%= @event.display_name %></h1>
      <% if @event.recurring_group_id.present? %>
        <span class="badge badge-sunrise">반복 일정</span>
      <% end %>
    </div>

    <dl class="grid grid-cols-2 gap-4">
      <div>
        <dt class="label-basalt">날짜</dt>
        <dd style="font-weight: 500;"><%= @event.date.strftime("%Y-%m-%d (%A)") %></dd>
      </div>
      <div>
        <dt class="label-basalt">시간</dt>
        <dd><%= @event.start_time.strftime("%H:%M") %><%= " ~ #{@event.end_time.strftime('%H:%M')}" if @event.end_time %></dd>
      </div>
      <div>
        <dt class="label-basalt">미사유형</dt>
        <dd><span class="badge badge-ocean"><%= @event.event_type.name %></span></dd>
      </div>
      <div>
        <dt class="label-basalt">장소</dt>
        <dd><%= @event.location || "-" %></dd>
      </div>
      <% if @event.notes.present? %>
        <div class="col-span-2">
          <dt class="label-basalt">비고</dt>
          <dd style="color: var(--basalt-600);"><%= @event.notes %></dd>
        </div>
      <% end %>
    </dl>

    <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
      <% if policy(@event).update? %>
        <%= link_to "수정", edit_event_path(@event), class: "btn-ocean" %>
      <% end %>
      <% if policy(@event).destroy? && !@event.has_assignments? %>
        <%= button_to "삭제", event_path(@event), method: :delete,
            class: "btn-lava",
            data: { turbo_confirm: "이 일정을 삭제하시겠습니까?" } %>
      <% end %>
      <% if policy(AttendanceRecord).edit? && @event.date <= Date.current %>
        <%= link_to "출결 기록", edit_event_attendance_path(@event), class: "btn-moss" %>
      <% end %>
      <%= link_to "목록", events_path, class: "btn-ghost" %>
    </div>
  </div>

  <!-- 역할별 배정 관리 -->
  <div class="card-basalt animate-in animate-delay-1" style="padding: 2rem;">
    <h2 class="section-title">역할별 배정 관리</h2>
    <% if @assignment_summary.any? %>
      <% @assignment_summary.each do |summary| %>
        <div style="border-bottom: 1px solid var(--basalt-100); padding: 1rem 0;">
          <div class="flex justify-between items-center" style="margin-bottom: 0.5rem;">
            <h3 style="font-weight: 600; font-size: 0.95rem;">
              <%= summary[:role].name %>
              <span style="color: var(--basalt-500); font-size: 0.8rem; font-weight: 400;">(<%= summary[:assigned] %>/<%= summary[:required] %>명)</span>
              <% if summary[:assigned] >= summary[:required] %>
                <span class="badge badge-moss" style="margin-left: 0.375rem;">완료</span>
              <% else %>
                <span class="badge badge-sunrise" style="margin-left: 0.375rem;">부족 (<%= summary[:required] - summary[:assigned] %>명)</span>
              <% end %>
            </h3>
            <% if policy(Assignment.new).create? && summary[:assigned] < summary[:required] %>
              <%= link_to "추천", recommend_event_assignments_path(@event, role_id: summary[:role].id),
                  class: "link-ocean", style: "font-size: 0.8rem;",
                  data: { turbo_frame: "recommend_#{summary[:role].id}" } %>
            <% end %>
          </div>

          <!-- 배정된 봉사자 목록 -->
          <% @event.assignments.where(role_id: summary[:role].id).where.not(status: "canceled").includes(:member).each do |assignment| %>
            <div class="flex justify-between items-center" style="padding: 0.375rem 0 0.375rem 1rem;">
              <span>
                <span style="font-size: 0.875rem;"><%= assignment.member.name %></span>
                <span class="badge
                  <%= case assignment.status
                      when 'accepted' then 'badge-moss'
                      when 'declined' then 'badge-lava'
                      when 'replaced' then 'badge-basalt'
                      when 'pending' then 'badge-sunrise'
                      else 'badge-basalt'
                      end %>"
                  style="margin-left: 0.25rem;<%= 'text-decoration: line-through;' if assignment.status == 'replaced' %>">
                  <%= case assignment.status
                      when 'accepted' then '수락'
                      when 'declined' then '거절'
                      when 'replaced' then '대타'
                      when 'pending' then '대기'
                      else assignment.status
                      end %>
                </span>
                <% if assignment.pending? && assignment.response_token.present? %>
                  <span style="font-size: 0.7rem; color: var(--ocean-600); margin-left: 0.25rem;" title="<%= response_url(assignment.response_token) %>">
                    (응답링크)
                  </span>
                <% end %>
              </span>
              <div class="flex items-center gap-2">
                <% if assignment.accepted? && policy(assignment).create? %>
                  <%= link_to "대타 요청", recommend_event_assignments_path(@event, role_id: assignment.role_id),
                      style: "font-size: 0.75rem; color: var(--sunrise-600);",
                      data: { turbo_frame: "substitute_#{assignment.id}" } %>
                <% end %>
                <% if assignment.declined? && assignment.replaced_by_id.nil? && policy(assignment).create? %>
                  <%= link_to "대타 추천", recommend_event_assignments_path(@event, role_id: assignment.role_id),
                      style: "font-size: 0.75rem; color: var(--sunrise-600);",
                      data: { turbo_frame: "substitute_#{assignment.id}" } %>
                <% end %>
                <% if policy(assignment).destroy? && !assignment.declined? && !assignment.status.in?(%w[replaced]) %>
                  <%= button_to "취소", event_assignment_path(@event, assignment),
                      method: :delete, style: "font-size: 0.75rem; color: var(--lava-500); background: none; border: none; cursor: pointer;",
                      data: { turbo_confirm: "#{assignment.member.name} 배정을 취소하시겠습니까?" } %>
                <% end %>
              </div>
            </div>
            <% if assignment.accepted? && policy(assignment).create? %>
              <%= turbo_frame_tag "substitute_#{assignment.id}" %>
            <% elsif assignment.declined? && assignment.replaced_by_id.nil? %>
              <%= turbo_frame_tag "substitute_#{assignment.id}" %>
            <% end %>
          <% end %>

          <!-- 수동 배정 폼 -->
          <% if policy(Assignment.new).create? && summary[:assigned] < summary[:required] %>
            <div style="margin-top: 0.5rem; padding-left: 1rem;">
              <%= form_with url: event_assignments_path(@event), class: "flex items-end gap-2" do |f| %>
                <input type="hidden" name="assignment[role_id]" value="<%= summary[:role].id %>">
                <div class="flex-1">
                  <%= select_tag "assignment[member_id]",
                      options_from_collection_for_select(Member.active.order(:name), :id, :name),
                      prompt: "봉사자 선택...",
                      class: "input-basalt", style: "font-size: 0.8rem;" %>
                </div>
                <%= f.submit "배정", class: "btn-ocean cursor-pointer", style: "font-size: 0.8rem; padding: 0.375rem 0.75rem;" %>
              <% end %>
            </div>
          <% end %>

          <!-- 추천 후보 Turbo Frame -->
          <%= turbo_frame_tag "recommend_#{summary[:role].id}" %>
        </div>
      <% end %>
    <% else %>
      <p style="color: var(--basalt-400); font-size: 0.875rem;">이 미사유형에 역할 템플릿이 설정되지 않았습니다.</p>
    <% end %>
  </div>
</div>
