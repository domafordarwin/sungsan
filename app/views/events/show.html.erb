<div class="max-w-3xl mx-auto">
  <div class="bg-white rounded-lg shadow p-8 mb-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold"><%= @event.display_name %></h1>
      <% if @event.recurring_group_id.present? %>
        <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm">반복 일정</span>
      <% end %>
    </div>

    <dl class="grid grid-cols-2 gap-4">
      <div>
        <dt class="text-sm text-gray-500">날짜</dt>
        <dd class="font-medium"><%= @event.date.strftime("%Y-%m-%d (%A)") %></dd>
      </div>
      <div>
        <dt class="text-sm text-gray-500">시간</dt>
        <dd><%= @event.start_time.strftime("%H:%M") %><%= " ~ #{@event.end_time.strftime('%H:%M')}" if @event.end_time %></dd>
      </div>
      <div>
        <dt class="text-sm text-gray-500">미사유형</dt>
        <dd><%= @event.event_type.name %></dd>
      </div>
      <div>
        <dt class="text-sm text-gray-500">장소</dt>
        <dd><%= @event.location || "-" %></dd>
      </div>
      <% if @event.notes.present? %>
        <div class="col-span-2">
          <dt class="text-sm text-gray-500">비고</dt>
          <dd><%= @event.notes %></dd>
        </div>
      <% end %>
    </dl>

    <div class="mt-6 flex gap-4">
      <% if policy(@event).update? %>
        <%= link_to "수정", edit_event_path(@event), class: "bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700" %>
      <% end %>
      <% if policy(@event).destroy? && !@event.has_assignments? %>
        <%= button_to "삭제", event_path(@event), method: :delete,
            class: "bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700",
            data: { turbo_confirm: "이 일정을 삭제하시겠습니까?" } %>
      <% end %>
      <% if policy(AttendanceRecord).edit? && @event.date <= Date.current %>
        <%= link_to "출결 기록", edit_event_attendance_path(@event),
            class: "bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700" %>
      <% end %>
      <%= link_to "목록", events_path, class: "text-gray-600 hover:text-gray-900 py-2" %>
    </div>
  </div>

  <!-- 역할별 배정 관리 -->
  <div class="bg-white rounded-lg shadow p-8">
    <h2 class="text-lg font-bold mb-4">역할별 배정 관리</h2>
    <% if @assignment_summary.any? %>
      <% @assignment_summary.each do |summary| %>
        <div class="border-b py-4 last:border-b-0">
          <div class="flex justify-between items-center mb-2">
            <h3 class="font-medium">
              <%= summary[:role].name %>
              <span class="text-sm text-gray-500">(<%= summary[:assigned] %>/<%= summary[:required] %>명)</span>
              <% if summary[:assigned] >= summary[:required] %>
                <span class="text-xs text-green-600 ml-1">완료</span>
              <% else %>
                <span class="text-xs text-orange-600 ml-1">부족 (<%= summary[:required] - summary[:assigned] %>명)</span>
              <% end %>
            </h3>
            <% if policy(Assignment.new).create? && summary[:assigned] < summary[:required] %>
              <%= link_to "추천", recommend_event_assignments_path(@event, role_id: summary[:role].id),
                  class: "text-sm text-green-600 hover:text-green-800",
                  data: { turbo_frame: "recommend_#{summary[:role].id}" } %>
            <% end %>
          </div>

          <!-- 배정된 봉사자 목록 -->
          <% @event.assignments.where(role_id: summary[:role].id).where.not(status: "canceled").includes(:member).each do |assignment| %>
            <div class="flex justify-between items-center py-1 pl-4">
              <span>
                <%= assignment.member.name %>
                <span class="text-xs px-2 py-0.5 rounded-full
                  <%= case assignment.status
                      when 'accepted' then 'bg-green-100 text-green-800'
                      when 'declined' then 'bg-red-100 text-red-800'
                      when 'replaced' then 'bg-gray-100 text-gray-500 line-through'
                      when 'pending' then 'bg-yellow-100 text-yellow-800'
                      else 'bg-gray-100 text-gray-800'
                      end %>">
                  <%= case assignment.status
                      when 'accepted' then '수락'
                      when 'declined' then '거절'
                      when 'replaced' then '대타'
                      when 'pending' then '대기'
                      else assignment.status
                      end %>
                </span>
                <% if assignment.pending? && assignment.response_token.present? %>
                  <span class="text-xs text-blue-500 ml-1" title="<%= response_url(assignment.response_token) %>">
                    (응답링크)
                  </span>
                <% end %>
              </span>
              <div class="flex items-center gap-2">
                <% if assignment.declined? && assignment.replaced_by_id.nil? && policy(assignment).create? %>
                  <%= link_to "대타 추천", recommend_event_assignments_path(@event, role_id: assignment.role_id),
                      class: "text-xs text-orange-600 hover:text-orange-800",
                      data: { turbo_frame: "substitute_#{assignment.id}" } %>
                <% end %>
                <% if policy(assignment).destroy? && !assignment.declined? && !assignment.status.in?(%w[replaced]) %>
                  <%= button_to "취소", event_assignment_path(@event, assignment),
                      method: :delete, class: "text-xs text-red-600 hover:text-red-800",
                      data: { turbo_confirm: "#{assignment.member.name} 배정을 취소하시겠습니까?" } %>
                <% end %>
              </div>
            </div>
            <% if assignment.declined? && assignment.replaced_by_id.nil? %>
              <%= turbo_frame_tag "substitute_#{assignment.id}" %>
            <% end %>
          <% end %>

          <!-- 수동 배정 폼 -->
          <% if policy(Assignment.new).create? && summary[:assigned] < summary[:required] %>
            <div class="mt-2 pl-4">
              <%= form_with url: event_assignments_path(@event), class: "flex items-end gap-2" do |f| %>
                <input type="hidden" name="assignment[role_id]" value="<%= summary[:role].id %>">
                <div class="flex-1">
                  <%= select_tag "assignment[member_id]",
                      options_from_collection_for_select(Member.active.order(:name), :id, :name),
                      prompt: "봉사자 선택...",
                      class: "w-full rounded-md border-gray-300 shadow-sm text-sm" %>
                </div>
                <%= f.submit "배정", class: "bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700 cursor-pointer" %>
              <% end %>
            </div>
          <% end %>

          <!-- 추천 후보 Turbo Frame -->
          <%= turbo_frame_tag "recommend_#{summary[:role].id}" %>
        </div>
      <% end %>
    <% else %>
      <p class="text-gray-500">이 미사유형에 역할 템플릿이 설정되지 않았습니다.</p>
    <% end %>
  </div>
</div>
