#!/bin/bash

echo "=== Starting AltarServe Manager ==="
echo "RAILS_ENV: ${RAILS_ENV:-not set}"
echo "DATABASE_URL set: $([ -n "$DATABASE_URL" ] && echo 'yes' || echo 'NO!')"

if [ "${1}" == "bundle" ]; then
  # Check if critical tables exist using psql directly
  echo "=== Checking database tables ==="
  TABLE_EXISTS=$(psql "$DATABASE_URL" -tAc "SELECT EXISTS (SELECT FROM information_schema.tables WHERE table_name = 'news_articles');" 2>/dev/null || echo "f")

  if [ "$TABLE_EXISTS" = "t" ]; then
    echo "Tables exist, running db:migrate for any pending migrations..."
    bundle exec rails db:migrate 2>&1 || echo "WARNING: db:migrate had issues"
  else
    echo "Tables missing! Running db:schema:load to create all tables..."
    bundle exec rails db:schema:load 2>&1 || {
      echo "schema:load failed, trying db:prepare..."
      bundle exec rails db:prepare 2>&1 || echo "CRITICAL: database setup failed"
    }
  fi

  echo "=== Running db:seed ==="
  bundle exec rails db:seed 2>&1 || echo "WARNING: db:seed skipped"

  echo "=== DB setup complete ==="
fi

echo "=== Starting server ==="
exec "${@}"
