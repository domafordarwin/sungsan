#!/bin/bash

echo "=== Starting AltarServe Manager ==="
echo "RAILS_ENV: ${RAILS_ENV:-not set}"
echo "PORT: ${PORT:-3000}"
echo "DATABASE_URL set: $([ -n "$DATABASE_URL" ] && echo 'yes' || echo 'NO!')"

if [ "${1}" == "bundle" ]; then
  # Step 1: Ensure DB exists
  echo "=== Step 1: Ensure database ==="
  bundle exec rails db:create 2>&1 || echo "(db already exists)"

  # Step 2: Run pending migrations
  echo "=== Step 2: db:migrate ==="
  bundle exec rails db:migrate 2>&1 || {
    echo "=== db:migrate failed, trying db:schema:load + db:migrate ==="
    bundle exec rails db:schema:load 2>&1 || echo "schema:load had issues"
    bundle exec rails db:migrate 2>&1 || echo "WARNING: migrate still failing"
  }

  # Step 3: Verify tables
  echo "=== Step 3: Verify tables ==="
  bundle exec rails runner "
    tables = %w[news_articles posts comments photo_albums photos active_storage_blobs]
    tables.each do |t|
      exists = ActiveRecord::Base.connection.table_exists?(t)
      puts \"  #{t}: #{exists ? 'OK' : 'MISSING'}\";
    end
  " 2>&1 || echo "Table verification skipped"

  # Step 4: Seed data
  echo "=== Step 4: db:seed ==="
  bundle exec rails db:seed 2>&1 || echo "WARNING: db:seed failed"

  echo "=== DB setup complete ==="
fi

echo "=== Starting Puma server ==="
exec "${@}"
