#!/bin/bash

echo "=== Starting AltarServe Manager ==="
echo "RAILS_ENV: ${RAILS_ENV:-not set}"
echo "DATABASE_URL set: $([ -n "$DATABASE_URL" ] && echo 'yes' || echo 'NO!')"

if [ "${1}" == "bundle" ]; then
  # SKIP_EAGER_LOAD=1 prevents Rails from introspecting tables that
  # don't exist yet (chicken-and-egg with eager_load + db:migrate).
  # db:prepare runs schema:load on fresh DBs, migrate on existing ones.
  echo "=== Running db:prepare ==="
  SKIP_EAGER_LOAD=1 bundle exec rails db:prepare 2>&1 || {
    echo "WARNING: db:prepare failed, trying db:migrate..."
    SKIP_EAGER_LOAD=1 bundle exec rails db:migrate 2>&1 || echo "WARNING: db:migrate also failed"
  }

  echo "=== Running db:seed ==="
  SKIP_EAGER_LOAD=1 bundle exec rails db:seed 2>&1 || echo "WARNING: db:seed skipped"

  echo "=== DB setup complete ==="
fi

echo "=== Starting server ==="
exec "${@}"
